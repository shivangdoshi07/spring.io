package com.shivang.secretsharing.Advices;

import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.Map;
import java.util.UUID;

import org.aopalliance.intercept.MethodInterceptor;
import org.aopalliance.intercept.MethodInvocation;
import org.springframework.cglib.proxy.MethodProxy;

import com.shivang.secretsharing.SecretServiceClass;
import com.shivang.secretsharing.Exceptions.UnauthorizedException;
import com.shivang.secretsharing.pojo.User;

public class HijackAround implements MethodInterceptor {

	private Map<String, User> usersDB;
	public Object invoke(MethodInvocation methodInvocation) throws Throwable {
		
		//SecretServiceClass ssc = (SecretServiceClass) methodInvocation.getClass();
		//usersDB = ssc.getUsersDB();
		
		String methodName = methodInvocation.getMethod().getName();
		Object arg1[] = methodInvocation.getArguments();
		
		if (methodName.equals("unshareSecret")) {
			System.out.println(arg1[0] + " unshares the secret of ID " + arg1[1] + " with " + arg1[2]);
			UUID key = (UUID) arg1[1];
			if (isAuthUnshare(arg1[0], key)) {
				// proceed to original method call
				return methodInvocation.proceed();
			}
		}
		return null;
	}

	public Object intercept(Object arg0, Method arg1, Object[] arg2, MethodProxy arg3) throws Throwable {
		System.err.println(arg0+""+arg1+""+Arrays.toString(arg2)+""+arg3);
		return null;
	}

	/*
	 * Checks if User can unshare Secret
	 */
	boolean isAuthUnshare(Object userID, UUID secretID) {
		if (!usersDB.get(userID).getOwnSecrets().containsKey(secretID)) {
			return false;
		}
		return true;
	}
}
